name: Send Notifications

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'  # Every hour on the hour

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      job:
        description: 'Notification job to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - study_reminders
          - streak_warnings
          - weekly_summary

jobs:
  send-notifications:
    name: Send Study Notifications
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Notification Job
        env:
          APP_URL: https://studek.com
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          JOB="${{ github.event.inputs.job || 'all' }}"

          echo "Triggering notification job: $JOB"
          echo "Time: $(date -u)"

          # Call the notification trigger API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            "$APP_URL/api/notifications/trigger?job=$JOB")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Notification job failed with status $HTTP_CODE"
            exit 1
          fi

          echo "Notification job completed successfully!"

  # Weekly summary - only on Sunday at 6 PM UTC
  weekly-summary:
    name: Send Weekly Summary (Sunday only)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Check if Sunday
        id: check-day
        run: |
          DAY_OF_WEEK=$(date -u +%u)
          HOUR=$(date -u +%H)
          echo "Day of week: $DAY_OF_WEEK (7=Sunday)"
          echo "Hour: $HOUR"

          # Only run on Sunday (7) at 18:00 UTC
          if [ "$DAY_OF_WEEK" = "7" ] && [ "$HOUR" = "18" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Weekly Summary
        if: steps.check-day.outputs.run == 'true'
        env:
          APP_URL: https://studek.com
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Sending weekly summary..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            "$APP_URL/api/notifications/trigger?job=weekly_summary")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"
